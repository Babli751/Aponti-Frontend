<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber Login Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8fffe; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { background: #00a693; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #007562; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .success { color: #00a693; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .step { margin: 10px 0; padding: 10px; border-left: 4px solid #00a693; }
        .step h4 { margin: 0 0 5px 0; color: #00a693; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Barber Login Debug Tool</h1>

        <div class="card">
            <h3>Step 1: Check Configuration</h3>
            <p><strong>API Base URL:</strong> <span id="apiBaseUrl">Loading...</span></p>
            <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
            <p><strong>Access Token:</strong> <span id="tokenStatus">Loading...</span></p>
            <button class="btn" onclick="checkConfig()">Refresh Config</button>
        </div>

        <div class="card">
            <h3>Step 2: Test API Connectivity</h3>
            <button class="btn" onclick="testAPIConnectivity()">Test API Connection</button>
            <div id="connectivityResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 3: Test Barber Login</h3>
            <div class="step">
                <h4>Login Credentials</h4>
                <p><strong>Email:</strong> barber2@test.com ‚úÖ</p>
                <p><strong>Password:</strong> 123456 ‚úÖ</p>
                <p><em>User created in database with is_barber=True</em></p>
            </div>
            <button class="btn" onclick="testBarberLogin()">Test Barber Login</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 4: Test Authentication</h3>
            <button class="btn" onclick="testAuthMe()">Test /auth/me</button>
            <div id="authResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 5: Test Dashboard Access</h3>
            <button class="btn" onclick="testDashboardAccess()">Test Dashboard Access</button>
            <button class="btn btn-danger" onclick="clearAllTokens()">Clear All Tokens</button>
            <div id="dashboardResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 6: Direct Navigation</h3>
            <button class="btn" onclick="goToBarberDashboard()">Go to Barber Dashboard</button>
            <button class="btn" onclick="goToBusinessSignup()">Go to Business Signup</button>
            <button class="btn" onclick="goToSignIn()">Go to Sign In</button>
        </div>

        <div class="card">
            <h3>Debug Information</h3>
            <div id="debugInfo" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://206.189.57.55:8001';

        window.onload = function() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('apiBaseUrl').textContent = API_BASE_URL;
            checkTokenStatus();
            updateDebugInfo();
        };

        function checkConfig() {
            document.getElementById('apiBaseUrl').textContent = API_BASE_URL;
            checkTokenStatus();
            updateDebugInfo();
        }

        function checkTokenStatus() {
            const token = localStorage.getItem('access_token');
            const businessToken = localStorage.getItem('business_token');
            const businessTokenAlt = localStorage.getItem('businessToken');

            document.getElementById('tokenStatus').innerHTML = `
                Access Token: ${token ? '‚úÖ Present' : '‚ùå Missing'}<br>
                Business Token: ${businessToken ? '‚úÖ Present' : '‚ùå Missing'}<br>
                BusinessToken: ${businessTokenAlt ? '‚úÖ Present' : '‚ùå Missing'}
            `;
        }

        function updateDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `
                Timestamp: ${new Date().toISOString()}<br>
                User Agent: ${navigator.userAgent}<br>
                Local Storage Keys: ${Object.keys(localStorage).join(', ')}<br>
                Cookies: ${document.cookie || 'None'}
            `;
        }

        async function makeRequest(url, method = 'GET', headers = {}, body = null) {
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };

            const token = localStorage.getItem('access_token');
            if (token) {
                defaultHeaders['Authorization'] = `Bearer ${token}`;
            }

            const config = {
                method,
                headers: { ...defaultHeaders, ...headers }
            };

            if (body) {
                config.body = JSON.stringify(body);
            }

            console.log('üîç Making request:', { url, method, headers: config.headers });

            const response = await fetch(url, config);
            const result = {
                url,
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                data: null,
                error: null
            };

            try {
                result.data = await response.json();
            } catch (e) {
                try {
                    result.error = await response.text();
                } catch (e2) {
                    result.error = 'Could not parse response';
                }
            }

            console.log('üì° Response:', result);
            return result;
        }

        function displayResult(elementId, result, title) {
            const element = document.getElementById(elementId);
            let content = `<strong>${title} (${new Date().toLocaleTimeString()}):</strong>\n`;
            content += `URL: ${result.url}\n`;
            content += `Status: ${result.status} ${result.statusText}\n`;

            if (result.data) {
                content += `Response: ${JSON.stringify(result.data, null, 2)}`;
            } else {
                content += `Error: ${result.error}`;
            }

            element.innerHTML = content;
            element.className = result.status >= 200 && result.status < 300 ? 'result success' : 'result error';
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
        }

        async function testAPIConnectivity() {
            console.log('üîç Testing API connectivity...');
            const result = await makeRequest(`${API_BASE_URL}/api/v1/business/`);

            displayResult('connectivityResult', result, 'API Connectivity Test');
        }

        async function testBarberLogin() {
            console.log('üîç Testing barber login...');

            const loginData = {
                username: 'barber2@test.com',
                password: '123456'
            };

            const result = await makeRequest(`${API_BASE_URL}/api/v1/auth/login`, 'POST', {
                'Content-Type': 'application/x-www-form-urlencoded',
            }, null);

            // Manually create form data
            const formData = new URLSearchParams();
            formData.append('username', 'barber2@test.com');
            formData.append('password', '123456');

            const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const data = await response.json();

            result.data = data;
            result.status = response.status;

            if (response.ok && data.access_token) {
                localStorage.setItem('access_token', data.access_token);
                checkTokenStatus();
                displayResult('loginResult', result, 'Barber Login Test - SUCCESS');
            } else {
                displayResult('loginResult', result, 'Barber Login Test - FAILED');
            }
        }

        async function testAuthMe() {
            console.log('üîç Testing /auth/me...');
            const result = await makeRequest(`${API_BASE_URL}/api/v1/auth/me`);

            displayResult('authResult', result, 'Auth Me Test');
        }

        async function testDashboardAccess() {
            console.log('üîç Testing dashboard access...');

            // First check if we have a token
            const token = localStorage.getItem('access_token');
            if (!token) {
                displayResult('dashboardResult', {
                    url: 'N/A',
                    status: 401,
                    statusText: 'Unauthorized',
                    error: 'No access token found. Please login first.'
                }, 'Dashboard Access Test - NO TOKEN');
                return;
            }

            // Test the barber profile endpoint
            const result = await makeRequest(`${API_BASE_URL}/api/v1/barbers/2`);
            displayResult('dashboardResult', result, 'Dashboard Access Test');
        }

        function clearAllTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('business_token');
            localStorage.removeItem('businessToken');
            checkTokenStatus();
            updateDebugInfo();

            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('authResult').innerHTML = '';
            document.getElementById('dashboardResult').innerHTML = '';

            alert('All tokens cleared!');
        }

        function goToBarberDashboard() {
            window.location.href = '/barber-dashboard';
        }

        function goToBusinessSignup() {
            window.location.href = '/business-signup';
        }

        function goToSignIn() {
            window.location.href = '/signin';
        }
    </script>
</body>
</html>