<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Barber Login</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8fffe; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { background: #00a693; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #007562; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .success { color: #00a693; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Barber Login</h1>

        <div class="card">
            <h3>Test Credentials</h3>
            <p><strong>Email:</strong> barber2@test.com ‚úÖ</p>
            <p><strong>Password:</strong> 123456 ‚úÖ</p>
            <p><strong>API URL:</strong> <span id="apiUrl">http://206.189.57.55:8001</span></p>
            <p><em>User created in database with is_barber=True</em></p>
        </div>

        <div class="card">
            <h3>Step 1: Test API Connection</h3>
            <button class="btn" onclick="testAPIConnection()">Test API Connection</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 2: Test Barber Login</h3>
            <button class="btn" onclick="testBarberLogin()">Test Barber Login</button>
            <div id="loginResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 3: Test Token Validation</h3>
            <button class="btn" onclick="testTokenValidation()">Test Token Validation</button>
            <div id="tokenResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Step 4: Test Barber Profile</h3>
            <button class="btn" onclick="testBarberProfile()">Test Barber Profile</button>
            <div id="profileResult" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>Actions</h3>
            <button class="btn" onclick="clearAllTokens()">Clear All Tokens</button>
            <button class="btn" onclick="goToBarberDashboard()">Go to Barber Dashboard</button>
            <button class="btn btn-danger" onclick="clearResults()">Clear Results</button>
        </div>

        <div class="card">
            <h3>Debug Info</h3>
            <div id="debugInfo" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://206.189.57.55:8001';

        window.onload = function() {
            document.getElementById('apiUrl').textContent = API_BASE_URL;
            updateDebugInfo();
        };

        function updateDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML = `
                Timestamp: ${new Date().toISOString()}<br>
                User Agent: ${navigator.userAgent}<br>
                Local Storage Keys: ${Object.keys(localStorage).join(', ')}<br>
                Access Token: ${localStorage.getItem('access_token') ? 'Present' : 'Missing'}<br>
                Business Token: ${localStorage.getItem('business_token') ? 'Present' : 'Missing'}
            `;
        }

        async function makeRequest(url, method = 'GET', headers = {}, body = null) {
            const defaultHeaders = {
                'Content-Type': 'application/json'
            };

            const token = localStorage.getItem('access_token');
            if (token) {
                defaultHeaders['Authorization'] = `Bearer ${token}`;
            }

            const config = {
                method,
                headers: { ...defaultHeaders, ...headers }
            };

            if (body) {
                config.body = JSON.stringify(body);
            }

            console.log('üîç Making request:', { url, method, headers: config.headers });

            const response = await fetch(url, config);
            const result = {
                url,
                status: response.status,
                statusText: response.statusText,
                headers: Object.fromEntries(response.headers.entries()),
                data: null,
                error: null
            };

            try {
                result.data = await response.json();
            } catch (e) {
                try {
                    result.error = await response.text();
                } catch (e2) {
                    result.error = 'Could not parse response';
                }
            }

            console.log('üì° Response:', result);
            return result;
        }

        function displayResult(elementId, result, title) {
            const element = document.getElementById(elementId);
            let content = `<strong>${title} (${new Date().toLocaleTimeString()}):</strong>\n`;
            content += `URL: ${result.url}\n`;
            content += `Status: ${result.status} ${result.statusText}\n`;

            if (result.data) {
                content += `Response: ${JSON.stringify(result.data, null, 2)}`;
            } else {
                content += `Error: ${result.error}`;
            }

            element.innerHTML = content;
            element.className = result.status >= 200 && result.status < 300 ? 'result success' : 'result error';
            element.style.display = 'block';
            element.scrollTop = element.scrollHeight;
            updateDebugInfo();
        }

        async function testAPIConnection() {
            console.log('üîç Testing API connection...');
            const result = await makeRequest(`${API_BASE_URL}/api/v1/business/`);

            displayResult('connectionResult', result, 'API Connection Test');
        }

        async function testBarberLogin() {
            console.log('üîç Testing barber login...');

            // Clear any existing tokens
            localStorage.removeItem('access_token');
            localStorage.removeItem('business_token');
            localStorage.removeItem('businessToken');

            const formData = new URLSearchParams();
            formData.append('username', 'barber2@test.com');
            formData.append('password', '123456');

            const response = await fetch(`${API_BASE_URL}/api/v1/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: formData
            });

            const data = await response.json();

            const result = {
                url: `${API_BASE_URL}/api/v1/auth/login`,
                status: response.status,
                statusText: response.statusText,
                data: data,
                error: null
            };

            if (response.ok && data.access_token) {
                localStorage.setItem('access_token', data.access_token);
                displayResult('loginResult', result, 'Barber Login Test - SUCCESS');
            } else {
                displayResult('loginResult', result, 'Barber Login Test - FAILED');
            }
        }

        async function testTokenValidation() {
            console.log('üîç Testing token validation...');
            const result = await makeRequest(`${API_BASE_URL}/api/v1/auth/me`);

            displayResult('tokenResult', result, 'Token Validation Test');
        }

        async function testBarberProfile() {
            console.log('üîç Testing barber profile...');
            const result = await makeRequest(`${API_BASE_URL}/api/v1/barbers/2`);

            displayResult('profileResult', result, 'Barber Profile Test');
        }

        function clearAllTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('business_token');
            localStorage.removeItem('businessToken');
            updateDebugInfo();
            alert('All tokens cleared!');
        }

        function goToBarberDashboard() {
            window.location.href = '/barber-dashboard';
        }

        function clearResults() {
            document.getElementById('connectionResult').innerHTML = '';
            document.getElementById('loginResult').innerHTML = '';
            document.getElementById('tokenResult').innerHTML = '';
            document.getElementById('profileResult').innerHTML = '';

            document.getElementById('connectionResult').style.display = 'none';
            document.getElementById('loginResult').style.display = 'none';
            document.getElementById('tokenResult').style.display = 'none';
            document.getElementById('profileResult').style.display = 'none';
        }
    </script>
</body>
</html>